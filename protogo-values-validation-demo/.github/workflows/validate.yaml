name: Plugin Validation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # Daily validation
  workflow_dispatch:
    inputs:
      plugin_version:
        description: 'Plugin version to validate'
        required: true
        default: 'latest'

jobs:
  validate-plugin:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.20', '1.21', '1.22']
        
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}
    
    - name: Install Dependencies
      run: |
        go install github.com/bufbuild/buf/cmd/buf@latest
        go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
        go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
    
    - name: Install Plugin
      run: |
        cd ../protogo-values
        go install ./cmd/protoc-gen-go-values
    
    - name: Generate Code
      run: |
        buf generate --template buf.gen.yaml
    
    - name: Run Type Validation
      run: |
        go test -v ./internal/validation -run TestPluginTypeTransformation
    
    - name: Run Performance Benchmarks
      run: |
        go test -bench=. -benchmem ./internal/validation
    
    - name: Run All Tests
      run: |
        go test -v ./internal/validation/
    
    - name: Build Project
      run: |
        go build ./...
        
    - name: Verify Generated Code
      run: |
        # Verify value slices were generated correctly
        grep -q "ValueSliceData \[\]DataPoint" gen/api/validation/v1/types.pb.go
        grep -q "PointerSliceData \[\]\*DataPoint" gen/api/validation/v1/types.pb.go
        grep -q "Results \[\]ProcessingResult" gen/api/validation/v1/types.pb.go
        echo "âœ… Plugin transformations verified successfully!"